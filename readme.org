#+TITLE: LaTeX table wizard - Magic editing of LaTeX tables
#+SUBTITLE: for version {{{version}}}
#+AUTHOR: Enrico Flor
#+EMAIL: enrico@eflor.net

#+OPTIONS: ':t toc:t author:t email:t
#+MACRO: version 0.1.0
#+MACRO: updated last updated 14 November 2022

Copyright (C) 2022 Enrico Flor.

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.3 or any later version published by the Free Software
     Foundation; with no Invariant Sections, with the Front-Cover Texts
     being “A GNU Manual,” and with the Back-Cover Texts as in (a)
     below.  A copy of the license is included in the section entitled
     “GNU Free Documentation License.”

     (a) The FSF’s Back-Cover Text is: “You have the freedom to copy and
     modify this GNU manual.”
* Overview

One of org-mode's magic features is its table editing capabilities.
The goal of this package is to replicate that luxury for LaTeX
table(-like) environments.

LaTeX-table-wizard's UI is based on [[https://elpa.gnu.org/packages/transient.html][transient]].  While the user can
change all the bindings, and can use all the commands without the
transient interface, this readme will refer to the commands through
the default bindings as they can be seen in the transient below.

The transient interface is invoked through the ~latex-table-wizard-do~
command, and exited, as usual, with ~C-g~.

An important feature of LaTeX-table-wizard is that it tries to be
smart: for instance, it should not be fooled if the current table-like
environments contains embedded tables (that is, other tabular
environments inside of its cells).  The table is parsed so that these
big cells are treated like any other cell.

[[./wizard-01.gif]]

* Available commands
For now, we will assume a standard LaTeX syntax for tabular
environments, where ~&~ delimits columns and ~\\~ rows (see [[#user-defined-envs][below]] for info
as to how to specify additional syntaxes).

Whenever we say "current" we mean "at point".

** Start editing
Just call ~latex-table-wizard-do~ when point is inside of table-like environment.
** Relative motion commands

These commands move point N cells to the right, left, down, and up.  N
is passed as a prefix argument, and if it's not passed, it defaults
to 1.

| Command                  | Default key |
|--------------------------+-------------|
| ~latex-table-wizard-right~ | ~f~           |
| ~latex-table-wizard-left~  | ~b~           |
| ~latex-table-wizard-down~  | ~n~           |
| ~latex-table-wizard-up~    | ~p~           |

With just one of these you can get anywhere you want in the table:

#+begin_src LaTeX
\begin{tabular}{lll}
  A0 & B0 & C0 \\\hline
  A1 & B1 & C1 \\
  A2 & B2 & C2
\end{tabular}
#+end_src

This is because these commands try to Do What You Mean if there is no
suitable cell to move to:

+ Point on ~C0~, ~latex-table-wizard-right~ ⇒ point on ~A1~
+ Point on ~A0~, ~latex-table-wizard-left~ ⇒ point on ~C2~
+ Point on ~C2~, ~latex-table-wizard-down~ ⇒ point on ~A0~
+ Point on ~B0~, ~latex-table-wizard-up~ ⇒ point on ~A2~

and so on.
** Absolute motion commands

| Command                              | Default key | Move to...                    |
|--------------------------------------+-------------+-------------------------------|
| ~latex-table-wizard-beginning-of-cell~ | ~a~           | end of current cell           |
| ~latex-table-wizard-end-of-cell~       | ~e~           | beginning of current cell     |
| ~latex-table-wizard-beginning-of-row~  | ~B~           | leftmost cell in current row  |
| ~latex-table-wizard-end-of-row~        | ~F~           | rightmost cell in current row |
| ~latex-table-wizard-bottom~            | ~N~           | bottom cell in current column |
| ~latex-table-wizard-top~               | ~P~           | top cell in current column    |
** Mark, kill and insert commands
| Command                          | Default key |                                            |
|----------------------------------+-------------+--------------------------------------------|
| ~latex-table-wizard-mark-cell~     | ~m c~         | mark current cell                          |
| ~latex-table-wizard-insert-column~ | ~i c~         | insert empty column to the right           |
| ~latex-table-wizard-insert-row~    | ~i r~         | insert row below                           |
| ~latex-table-wizard-kill-column~   | ~k c~         | add content of current column to kill ring |
| ~latex-table-wizard-kill-row~      | ~k r~         | add content of current row to kill ring    |
| ~exchange-point-and-mark~          | ~x~           |                                            |
** Swap adjacent fields

| Command                              | Default key | Swap current...                  |
|--------------------------------------+-------------+----------------------------------|
| ~latex-table-wizard-swap-cell-right~   | ~C-f~         | cell with the one to the right   |
| ~latex-table-wizard-swap-cell-left~    | ~C-b~         | cell with the one to the left    |
| ~latex-table-wizard-swap-cell-down~    | ~C-n~         | cell with the one below          |
| ~latex-table-wizard-swap-cell-up~      | ~C-p~         | cell with the one above          |
| ~latex-table-wizard-swap-column-right~ | ~M-f~         | column with the one to the right |
| ~latex-table-wizard-swap-column-left~  | ~M-b~         | column with the one to the left  |
| ~latex-table-wizard-swap-row-down~     | ~M-n~         | row with the one below           |
| ~latex-table-wizard-swap-row-up~       | ~M-p~         | row with the one above           |

For these commands, think of the cells and columns as circular: if
there is no item in the direction given, the target is the one on the
opposite end of the current cell.  So for example:

#+begin_src LaTeX
\begin{tabular}{lll}
  A0 & B0 & C0 \\\hline
  A1 & B1 & C1 \\
  A2 & B2 & C2
\end{tabular}
#+end_src

This is because these commands try to Do What You Mean if there is no
suitable cell to move to:

+ Point on ~B0~, ~latex-table-wizard-swap-row-up~
  ⇒
#+begin_src LaTeX
\begin{tabular}{lll}
 A2  & B2  & C2  \\\hline
  A1 & B1 & C1 \\
 A0  & B0  & C0
\end{tabular}
#+end_src
+ Point on ~C2~, ~latex-table-wizard-swap-cell-right~
  ⇒
#+begin_src latex
\begin{tabular}{lll}
 C0  & B0 & A0  \\\hline
  A1 & B1 & C1 \\
  A2 & B2 & C2
\end{tabular}
#+end_src

** Swap arbitrary fields
To swap arbitrary fields one must first *select* something and then
move point somewhere else and perform the swap.  Importantly,
*selecting does not mean marking*: the mark is not even moved when
selecting.

The simplest case is one in which the current cell, column or row are
selected:

| Command                          | Default key | Select current... |
|----------------------------------+-------------+-------------------|
| ~latex-table-wizard-select-cell~   | ~SPC~         | cell              |
| ~latex-table-wizard-select-column~ | ~c~           | column            |
| ~latex-table-wizard-select-row~    | ~r~           | row               |

Things can be deselected too:

| Command                              | Default key | Deselect current... |
|--------------------------------------+-------------+---------------------|
| ~latex-table-wizard-deselect-cell~   | ~d SPC~     | cell                |
| ~latex-table-wizard-deselect-column~ | ~d c~       | column              |
| ~latex-table-wizard-deselect-row~    | ~d r~       | row                 |

Once things are selected, you move point somewhere else in the table
(with the above mentioned motion commands), and then:

| ~latex-table-wizard-swap~ | ~s~ | swap selection and current thing |

What is swapped depends on what is selected: if the selection was only
a cell, then that cell and the current one are swapped.  If it was (a
potentially discontinuous segment of) a column or a row, then that
selection is swapped with the current column or row or the
corresponding portion thereof.  If you selected multiple cell that are
not part of the same column or row, the swap won't happen
(LaTeX-table-wizard doesn't know what to do).

** Format the table

Two more command fix the appearance of the table.  To "compress" the
table by removing excess white space at the edges of each cell, call
~latex-table-wizard-clean-whitespace~.

Call ~latex-table-wizard-align~ if you want the columns to be vertically
aligned too (and each row starting on its own line).  This alignment
command tries to be smart and not be fooled by column or row
delimiters embedded in a cell.

| Command                             | Default key |
|-------------------------------------+-------------|
| ~latex-table-wizard-clean-whitespace~ | ~w~           |
| ~latex-table-wizard-align~            | ~TAB~         |


* Customization
** Change keybindings
To change the default keybindings, you need to provide a new
definition of the transient prefix ~latex-table-wizard-do~ through the
macro ~transient-define-prefix~.

The default definition, which is the one assumed in this readme so
far, is below:

#+begin_src emacs-lisp
(transient-define-prefix latex-table-wizard-prefix ()
  [:description
   "      LaTeX table wizard"
   ["Motion"
    ;; latex-table-wizard--motion-suffixes
    ("f" "move right" latex-table-wizard-right :transient t)
    ("b" "move left" latex-table-wizard-left :transient t)
    ("p" "move down" latex-table-wizard-up :transient t)
    ("n" "move up" latex-table-wizard-down :transient t)
    ""
    ("F" "end of row" latex-table-wizard-end-of-row :transient t)
    ("B" "beginning of row" latex-table-wizard-beginning-of-row :transient t)
    ("P" "top" latex-table-wizard-top :transient t)
    ("N" "bottom" latex-table-wizard-bottom :transient t)
    ""
    ("a" "beginning of cell" latex-table-wizard-beginning-of-cell :transient t)
    ("e" "end of cell" latex-table-wizard-end-of-cell :transient t)
    ""
    ("u" "universal argument" universal-argument :transient t)]
   ["Swap"
    ;; latex-table-wizard--swap-cell-suffixes
    ("C-f" "swap cell right" latex-table-wizard-swap-cell-right :transient t)
    ("C-b" "swap cell left" latex-table-wizard-swap-cell-left :transient t)
    ("C-p" "swap cell up" latex-table-wizard-swap-cell-up :transient t)
    ("C-n" "swap cell down" latex-table-wizard-swap-cell-down :transient t)
    ""
    ;; latex-table-wizard--swap-line-suffixes
    ("M-f" "swap column right" latex-table-wizard-swap-column-right :transient t)
    ("M-b" "swap column left" latex-table-wizard-swap-column-left :transient t)
    ("M-p" "swap row up" latex-table-wizard-swap-row-up :transient t)
    ("M-n" "swap row down" latex-table-wizard-swap-row-down :transient t)
    ""
    "Other"
    ;; latex-table-wizard--other-suffixes
    ("w" "compress table" latex-table-wizard-clean-whitespace :transient t)
    ("TAB" "align table" latex-table-wizard-align :transient t)
    ("/" "undo" undo :transient t)
    ""
    ("RET" "done" transient-quit-one)]
   ["Select and swap"
    ("SPC" "select cell" latex-table-wizard-select-cell :transient t)
    ("c" "select column" latex-table-wizard-select-column :transient t)
    ("r" "select row" latex-table-wizard-select-row :transient t)
    ("d SPC" "deselect cell" latex-table-wizard-deselect-cell :transient t)
    ("d c" "select column" latex-table-wizard-deselect-column :transient t)
    ("d r" "select row" latex-table-wizard-deselect-row :transient t)
    ""
    ("s" "swap selection" latex-table-wizard-swap :transient t)
    ""
    "Mark, kill and insert"
    ;; latex-table-wizard--mark-suffixes
    ("x" "exchange point and mark" exchange-point-and-mark :transient t)
    ("m c" "mark cell" latex-table-wizard-mark-cell :transient t)
    ("i c" "insert column right" latex-table-wizard-insert-column :transient t)
    ("i r" "insert row below" latex-table-wizard-insert-row :transient t)
    ("k c" "kill current column" latex-table-wizard-kill-column :transient t)
    ("k r" "kill current row" latex-table-wizard-kill-row :transient t)]])
#+end_src

Just put a copy of this macro calling with the appropriate
modifications in your configuration file.  The first element of each
list in the vectors is the key (given in the same syntax as the ~kbd~
macro accepts).  You can also move around or remove some of these
cells if you want to change the layout of the transient interface.


** Define rules for new environments
:PROPERTIES:
:CUSTOM_ID: user-defined-envs
:END:
Remember the default values used for parsing table environments:

#+begin_src emacs-lisp
(defconst latex-table-wizard-column-delimiters '("&")
  "List of strings that are column delimiters if unescaped.")

(defconst latex-table-wizard-row-delimiters '("\\\\\\\\")
  "List of strings that are row delimiters if unescaped.")

(defvar latex-table-wizard-hline-macros '("hline"
                                          "midrule"
                                          "toprule"
                                          "bottomrule"))
#+end_src

 LaTeX-table-wizard will always presume the table you want operate on
 has a syntax specified like this.  But suppose you use different
 environments with non-standard syntax: suppose you define a
 table-like environment of your choice, let's call it ~mytable~, that
 uses ~!ROW~ and ~!COL~ instead of ~&~ and ~\\~ as delimiters, and a macro
 ~\horizontal~ for horizontal lines.  When you are in a ~mytable~
 environments, you want LaTeX-table-wizard to adapt to this new
 syntax.

 All you need to do add an appropriate cons cell to the
 ~latex-table-wizard-new-environments-alist~ association list, mapping
 the name of the environment, as a string, to a property list
 specifying the values.  For the case of ~mytable~ you would do:

 #+begin_src emacs-lisp
(add-to-list 'latex-table-wizard-new-environments-alist
             '("mytable" . (:col ("!COL") :row ("!ROW") :lines ("horizontal"))))
 #+end_src
